# 本地开发服务器使用指南

## 概述

本项目配置了智能端口管理的本地开发服务器，能够自动处理端口占用问题。

## 功能特性

### 1. 智能端口管理
- **默认端口**: 从 `.env.local` 文件中读取 `PORT` 配置（当前为 5000）
- **端口占用检测**: 自动检测配置的端口是否被占用
- **进程关闭**: 如果端口被占用，尝试关闭占用的进程
- **自动切换**: 如果无法关闭占用进程，自动寻找下一个可用端口

### 2. 服务器特性
- 静态文件服务
- 支持所有 HTML 页面访问
- 自动路由处理
- 404 错误处理

## 使用方法

### 方法 1：使用启动脚本（推荐）

双击运行 `start.bat` 文件，或在命令行中执行：

```bash
start.bat
```

### 方法 2：使用 npm 命令

```bash
# 首次使用需要安装依赖
npm install

# 启动开发服务器
npm start
# 或
npm run dev
```

### 方法 3：直接运行 Node.js

```bash
node server.js
```

## 端口配置

### 修改默认端口

编辑 `.env.local` 文件中的 `PORT` 配置：

```env
# Server Configuration
PORT=5000  # 修改为你想要的端口号
```

### 端口冲突处理流程

1. **检测端口占用**
   - 服务器启动时自动检测配置的端口是否可用

2. **尝试关闭占用进程**
   - 如果端口被占用，显示占用进程的 PID
   - 尝试使用 `taskkill` 命令关闭该进程
   - 等待 1 秒后检查端口是否已释放

3. **自动切换端口**
   - 如果无法关闭占用进程
   - 或者进程关闭后端口仍被占用
   - 自动从下一个端口开始，最多尝试 100 个端口
   - 找到可用端口后启动服务器

## 启动日志示例

### 正常启动（端口可用）

```
🐟 Fish Art 本地开发服务器启动中...

📋 配置的端口: 5000 (来自 .env.local)
✅ 端口 5000 可用

==================================================
🚀 服务器已启动！
📍 本地访问: http://localhost:5000
📍 网络访问: http://127.0.0.1:5000
==================================================

按 Ctrl+C 停止服务器
```

### 端口被占用，成功关闭进程

```
🐟 Fish Art 本地开发服务器启动中...

📋 配置的端口: 5000 (来自 .env.local)

⚠️  端口 5000 已被占用
📌 占用进程 PID: 12345

尝试关闭占用端口的进程 PID: 12345
✅ 成功关闭进程 12345
✅ 端口 5000 已释放，使用原端口启动

==================================================
🚀 服务器已启动！
📍 本地访问: http://localhost:5000
📍 网络访问: http://127.0.0.1:5000
==================================================

按 Ctrl+C 停止服务器
```

### 端口被占用，切换到新端口

```
🐟 Fish Art 本地开发服务器启动中...

📋 配置的端口: 5000 (来自 .env.local)

⚠️  端口 5000 已被占用
📌 占用进程 PID: 12345

尝试关闭占用端口的进程 PID: 12345
❌ 无法关闭进程 12345: 访问被拒绝
⚠️  无法关闭占用进程，寻找新端口...
✅ 找到可用端口: 5001

==================================================
🚀 服务器已启动！
📍 本地访问: http://localhost:5001
📍 网络访问: http://127.0.0.1:5001
==================================================

按 Ctrl+C 停止服务器
```

## 停止服务器

在服务器运行的终端中按 `Ctrl + C` 即可停止服务器。

## 故障排查

### 问题 1：无法安装依赖

**错误信息**：`npm install` 失败

**解决方法**：
```bash
# 清除 npm 缓存
npm cache clean --force

# 重新安装
npm install
```

### 问题 2：无法关闭占用进程

**错误信息**：`访问被拒绝` 或 `无法关闭进程`

**原因**：可能是系统进程或需要管理员权限的进程

**解决方法**：
1. 以管理员身份运行命令提示符或 PowerShell
2. 或者让服务器自动切换到新端口（已自动实现）

### 问题 3：找不到可用端口

**错误信息**：`无法找到可用端口`

**解决方法**：
- 检查是否有大量服务占用端口
- 重启计算机释放端口
- 手动修改 `.env.local` 中的 `PORT` 为更高的端口号（如 8000）

### 问题 4：服务器启动但无法访问

**解决方法**：
1. 检查防火墙设置
2. 确认浏览器中输入的端口号与服务器显示的一致
3. 尝试使用 `127.0.0.1` 替代 `localhost`

## 开发建议

### 1. 多项目开发

如果同时开发多个项目，建议为每个项目配置不同的默认端口：

```env
# 项目 A
PORT=5000

# 项目 B
PORT=5100

# 项目 C
PORT=5200
```

### 2. 团队协作

确保团队成员使用相同的 `.env.local` 配置，可以创建 `.env.example` 文件作为模板：

```bash
# 复制示例配置
cp .env.local .env.example

# 团队成员克隆项目后
cp .env.example .env.local
```

### 3. 持续集成

在 CI/CD 环境中，可以通过环境变量覆盖 `.env.local` 的配置：

```bash
PORT=8080 node server.js
```

## 技术细节

### 端口检测原理

使用 Node.js 的 `net` 模块尝试监听指定端口：
- 如果监听成功则端口可用
- 如果抛出 `EADDRINUSE` 错误则端口被占用

### 进程查询原理（Windows）

使用 `netstat -ano` 命令查询端口占用情况：
- 查找 `LISTENING` 状态的连接
- 提取进程 PID

### 进程关闭原理（Windows）

使用 `taskkill /PID [PID] /F` 命令强制关闭进程：
- `/F` 参数表示强制关闭
- 关闭后等待 1 秒让系统释放端口

## 相关文件

- `server.js` - 服务器主文件
- `package.json` - npm 配置文件
- `.env.local` - 环境变量配置
- `start.bat` - Windows 启动脚本

## 更新日志

### 2025-11-03
- ✅ 创建智能端口管理的开发服务器
- ✅ 实现端口占用检测
- ✅ 实现自动关闭占用进程
- ✅ 实现自动切换可用端口
- ✅ 添加详细的启动日志
- ✅ 创建 Windows 启动脚本





