# 需求文档

## 简介

本功能旨在通过 Supabase 匿名认证降低用户注册门槛，让新用户无需任何操作即可开始使用应用。匿名用户可以体验完整功能，并在需要时升级为正式账号以保留数据。

## 术语表

- **匿名用户**: 通过 Supabase `signInAnonymously()` 创建的临时用户，拥有真实的 UUID，但未绑定邮箱或社交账号
- **正式用户**: 已绑定邮箱或社交账号的用户
- **账号升级**: 匿名用户绑定邮箱或社交账号，转换为正式用户的过程
- **会话**: Supabase 存储在浏览器中的认证状态，包含 access_token 和 refresh_token
- **系统**: 本应用的认证和用户管理系统
- **RLS**: Row Level Security，Supabase 的行级安全策略，用于控制数据访问权限
- **Free 用户**: 免费会员，拥有基础功能权限

## 需求列表

### 需求 1

**用户故事:** 作为新访客，我希望无需注册即可立即使用应用，以便在决定注册前先体验功能。

#### 验收标准

1. 当访客访问应用且没有现有会话时，系统应自动创建匿名用户账号
2. 当匿名用户创建成功时，系统应生成唯一用户ID并将会话存储在浏览器中
3. 当匿名用户访问受保护功能时，系统应授予与 Free 用户相同的权限（不新建会员类型）
4. 当匿名用户带着有效会话返回应用时，系统应恢复之前的匿名账号

### 需求 2

**用户故事:** 作为匿名用户，我希望通过添加邮箱或社交登录来升级账号，以便在不同设备和浏览器间保留我的数据。

#### 验收标准

1. 当匿名用户使用邮箱发起账号升级时，系统应将邮箱关联到现有匿名账号
2. 当匿名用户使用社交账号发起账号升级时，系统应将社交身份关联到现有匿名账号
3. 当账号升级成功完成时，系统应保留与匿名用户ID关联的所有数据
4. 当账号升级因邮箱已被使用而失败时，系统应显示错误信息并保持匿名会话

### 需求 3

**用户故事:** 作为用户，我希望清楚地看到我的账号状态，以便知道我使用的是临时账号还是永久账号。

#### 验收标准

1. 当显示匿名用户信息时，系统应展示"访客"标识和升级提示
2. 当显示正式用户信息时，系统应展示用户的邮箱或社交账号名称
3. 当匿名用户查看个人资料时，系统应显示醒目的升级选项

### 需求 4

**用户故事:** 作为付费用户，我希望确保订阅与永久账号关联，以免失去高级功能的访问权限。

#### 验收标准

1. 当匿名用户尝试购买订阅时，系统应要求先升级账号再进行支付
2. 当正式用户拥有有效订阅时，系统应在各会话间保持订阅访问权限

### 需求 5

**用户故事:** 作为系统管理员，我希望匿名会话得到妥善管理，以保持系统性能和安全性。

#### 验收标准

1. 当匿名会话过期或被清除时，系统应允许创建新的匿名账号
2. 当浏览器存储被清除时，系统应将访客视为新用户
3. 当检测到潜在滥用模式时，系统应对匿名账号创建实施速率限制

### 需求 6

**用户故事:** 作为系统管理员，我希望匿名用户的数据访问受到适当的 RLS 策略保护，以确保数据安全。

#### 验收标准

1. 当匿名用户访问数据时，RLS 策略应基于 `auth.uid()` 进行权限验证（与正式用户相同）
2. 当匿名用户创建数据时，系统应将数据关联到匿名用户的 UUID
3. 当匿名用户查询数据时，系统应仅返回该用户拥有的数据
4. 当匿名用户升级为正式用户时，RLS 策略应继续使用相同的 UUID 进行验证

### 需求 7

**用户故事:** 作为新访客，我希望有清晰的入口开始使用应用，以便快速体验功能。

#### 验收标准

1. 当访客首次访问主页时，系统应显示"立即体验"按钮作为匿名登录入口
2. 当访客点击"立即体验"按钮时，系统应自动创建匿名账号并跳转到主功能页面
3. 当登录弹窗显示时，系统应提供"跳过登录，先体验"选项
4. 当访客选择跳过登录时，系统应创建匿名账号并关闭弹窗
