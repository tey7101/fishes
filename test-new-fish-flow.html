<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ–°é±¼åŠ è½½æµç¨‹æµ‹è¯•</title>
    <style>
        body {
            font-family: 'Courier New', monospace;
            padding: 20px;
            background: #1e1e1e;
            color: #d4d4d4;
        }
        .log-container {
            background: #252526;
            border: 1px solid #3e3e42;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            max-height: 600px;
            overflow-y: auto;
        }
        .log-entry {
            margin: 5px 0;
            padding: 5px;
            border-left: 3px solid #007acc;
        }
        .log-success { border-left-color: #4ec9b0; color: #4ec9b0; }
        .log-error { border-left-color: #f48771; color: #f48771; }
        .log-warning { border-left-color: #dcdcaa; color: #dcdcaa; }
        .log-info { border-left-color: #569cd6; color: #569cd6; }
        .test-button {
            background: #0e639c;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
        }
        .test-button:hover {
            background: #1177bb;
        }
        .test-button:disabled {
            background: #555;
            cursor: not-allowed;
        }
        h1 { color: #569cd6; }
        h2 { color: #4ec9b0; margin-top: 30px; }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            font-weight: bold;
        }
        .status-testing { background: #1e3a5f; color: #569cd6; }
        .status-success { background: #1e4d2b; color: #4ec9b0; }
        .status-error { background: #4d1e1e; color: #f48771; }
        .json-viewer {
            background: #1e1e1e;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            font-size: 12px;
            overflow-x: auto;
        }
        pre {
            margin: 0;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
    </style>
</head>
<body>
    <h1>ğŸ§ª æ–°é±¼åŠ è½½æµç¨‹è‡ªåŠ¨æµ‹è¯•</h1>
    
    <div class="status status-testing" id="status">
        â³ å‡†å¤‡å°±ç»ªï¼Œç­‰å¾…æµ‹è¯•...
    </div>
    
    <div>
        <button class="test-button" onclick="testNewFishFlow()">ğŸš€ å¼€å§‹å®Œæ•´æµ‹è¯•</button>
        <button class="test-button" onclick="testFishQuery()">ğŸ” æµ‹è¯•æŸ¥è¯¢å·²å­˜åœ¨çš„é±¼</button>
        <button class="test-button" onclick="clearLogs()">ğŸ—‘ï¸ æ¸…ç©ºæ—¥å¿—</button>
    </div>

    <h2>ğŸ“‹ æµ‹è¯•æ­¥éª¤</h2>
    <div class="json-viewer">
        <pre>1. æ¨¡æ‹Ÿç”»é±¼å¹¶æäº¤ï¼ˆä½¿ç”¨æµ‹è¯•å›¾ç‰‡ï¼‰
2. è·å–è¿”å›çš„é±¼ID
3. æ„å»ºè·³è½¬URL: tank.html?newFish={id}&sort=random
4. æµ‹è¯• getFishById() åŠ è½½é±¼æ•°æ®
5. æ£€æŸ¥å›¾ç‰‡URLå’Œæ•°æ®å®Œæ•´æ€§
6. éªŒè¯æ–°é±¼èƒ½å¦æ­£å¸¸åŠ è½½åˆ°é±¼ç¼¸</pre>
    </div>

    <h2>ğŸ“ æµ‹è¯•æ—¥å¿—</h2>
    <div class="log-container" id="logContainer"></div>

    <h2>ğŸ“Š æµ‹è¯•ç»“æœ</h2>
    <div class="json-viewer" id="resultContainer"></div>

    <script src="src/js/fish-utils.js"></script>
    <script>
        let testResults = {
            steps: [],
            errors: [],
            fishId: null,
            fishData: null
        };

        function log(message, type = 'info') {
            const container = document.getElementById('logContainer');
            const entry = document.createElement('div');
            entry.className = `log-entry log-${type}`;
            
            const timestamp = new Date().toLocaleTimeString('zh-CN', { 
                hour12: false, 
                hour: '2-digit', 
                minute: '2-digit', 
                second: '2-digit',
                fractionalSecondDigits: 3
            });
            
            entry.innerHTML = `<span style="color: #858585">[${timestamp}]</span> ${message}`;
            container.appendChild(entry);
            container.scrollTop = container.scrollHeight;

            // åŒæ—¶è¾“å‡ºåˆ°æµè§ˆå™¨æ§åˆ¶å°
            const consoleMsg = `[æµ‹è¯•] ${message.replace(/<[^>]*>/g, '')}`;
            switch(type) {
                case 'success': console.log('%c' + consoleMsg, 'color: #4ec9b0'); break;
                case 'error': console.error(consoleMsg); break;
                case 'warning': console.warn(consoleMsg); break;
                default: console.log(consoleMsg);
            }
        }

        function setStatus(message, type = 'testing') {
            const status = document.getElementById('status');
            status.className = `status status-${type}`;
            status.innerHTML = message;
        }

        function showResults() {
            const container = document.getElementById('resultContainer');
            container.innerHTML = '<pre>' + JSON.stringify(testResults, null, 2) + '</pre>';
        }

        function clearLogs() {
            document.getElementById('logContainer').innerHTML = '';
            document.getElementById('resultContainer').innerHTML = '';
            testResults = {
                steps: [],
                errors: [],
                fishId: null,
                fishData: null
            };
            setStatus('â³ æ—¥å¿—å·²æ¸…ç©ºï¼Œå‡†å¤‡æ–°æµ‹è¯•...', 'testing');
        }

        async function testFishQuery() {
            const fishId = prompt('è¯·è¾“å…¥è¦æŸ¥è¯¢çš„é±¼ID:');
            if (!fishId) return;

            setStatus('ğŸ” æ­£åœ¨æŸ¥è¯¢é±¼æ•°æ®...', 'testing');
            log(`å¼€å§‹æŸ¥è¯¢é±¼ID: <strong>${fishId}</strong>`, 'info');

            try {
                log('è°ƒç”¨ getFishById()...', 'info');
                const fishData = await getFishById(fishId);
                
                if (fishData) {
                    log('âœ… æˆåŠŸåŠ è½½é±¼æ•°æ®ï¼', 'success');
                    log(`é±¼åç§°: <strong>${fishData.fish_name || 'æœªå‘½å'}</strong>`, 'success');
                    log(`è‰ºæœ¯å®¶: <strong>${fishData.artist || 'Anonymous'}</strong>`, 'success');
                    log(`å›¾ç‰‡URL: <code>${fishData.image_url}</code>`, 'success');
                    log(`is_approved: <strong>${fishData.is_approved}</strong>`, 'success');
                    
                    testResults.fishData = fishData;
                    setStatus('âœ… æŸ¥è¯¢æˆåŠŸï¼', 'success');
                } else {
                    log('âŒ æœªæ‰¾åˆ°é±¼æ•°æ®', 'error');
                    log('å¯èƒ½åŸå› : 1) IDä¸å­˜åœ¨ 2) is_approved=false 3) ç½‘ç»œé”™è¯¯', 'warning');
                    setStatus('âŒ æŸ¥è¯¢å¤±è´¥', 'error');
                }
                
                showResults();
            } catch (error) {
                log(`âŒ æŸ¥è¯¢å‡ºé”™: ${error.message}`, 'error');
                testResults.errors.push({ step: 'query', error: error.message });
                setStatus('âŒ æŸ¥è¯¢å¤±è´¥', 'error');
                showResults();
            }
        }

        async function testNewFishFlow() {
            clearLogs();
            setStatus('ğŸš€ å¼€å§‹å®Œæ•´æµ‹è¯•æµç¨‹...', 'testing');
            
            log('<h3>ğŸ¨ æ­¥éª¤ 1: æ¨¡æ‹Ÿç”»é±¼æäº¤</h3>', 'info');
            log('âš ï¸ æ³¨æ„: è¿™æ˜¯æ¨¡æ‹Ÿæµ‹è¯•ï¼Œéœ€è¦å®é™…ç”»é±¼æ¥è·å–çœŸå®ID', 'warning');
            log('è¯·åœ¨å®é™…åº”ç”¨ä¸­ç”»ä¸€æ¡é±¼ï¼Œç„¶åæŸ¥çœ‹æ§åˆ¶å°è·å–é±¼ID', 'info');
            
            // æç¤ºç”¨æˆ·è¾“å…¥çœŸå®çš„é±¼ID
            const realFishId = prompt('è¯·å…ˆåœ¨ä¸»é¡µç”»ä¸€æ¡é±¼å¹¶æäº¤ï¼Œç„¶åè¾“å…¥é±¼IDï¼ˆåœ¨æ§åˆ¶å°å¯ä»¥çœ‹åˆ°ï¼‰:');
            
            if (!realFishId) {
                log('âŒ æµ‹è¯•å–æ¶ˆï¼šæœªæä¾›é±¼ID', 'error');
                setStatus('âŒ æµ‹è¯•å–æ¶ˆ', 'error');
                return;
            }
            
            testResults.fishId = realFishId;
            log(`ä½¿ç”¨é±¼ID: <strong>${realFishId}</strong>`, 'success');
            testResults.steps.push({ step: 1, status: 'success', fishId: realFishId });

            // æ­¥éª¤ 2: æ„å»ºURL
            log('<h3>ğŸ”— æ­¥éª¤ 2: æ„å»ºè·³è½¬URL</h3>', 'info');
            const tankUrl = `tank.html?newFish=${encodeURIComponent(realFishId)}&sort=random`;
            log(`ç”Ÿæˆçš„URL: <code>${tankUrl}</code>`, 'success');
            testResults.steps.push({ step: 2, status: 'success', url: tankUrl });

            // æ­¥éª¤ 3: æµ‹è¯• getFishById
            log('<h3>ğŸ  æ­¥éª¤ 3: æµ‹è¯• getFishById()</h3>', 'info');
            setStatus('ğŸ” æ­£åœ¨ä»æ•°æ®åº“åŠ è½½é±¼...', 'testing');
            
            try {
                log('è°ƒç”¨ getFishById() åŠ è½½é±¼æ•°æ®...', 'info');
                const fishData = await getFishById(realFishId);
                
                if (!fishData) {
                    log('âŒ getFishById() è¿”å› null', 'error');
                    log('è¿™æ„å‘³ç€æ–°é±¼æ— æ³•è¢«åŠ è½½ï¼', 'error');
                    log('è¯·æ£€æŸ¥: 1) é±¼æ˜¯å¦å·²åˆ›å»º 2) IDæ˜¯å¦æ­£ç¡® 3) is_approvedçŠ¶æ€', 'warning');
                    testResults.steps.push({ step: 3, status: 'error', reason: 'fishData is null' });
                    testResults.errors.push({ step: 'getFishById', error: 'Returned null' });
                    setStatus('âŒ æµ‹è¯•å¤±è´¥ï¼šæ— æ³•åŠ è½½é±¼æ•°æ®', 'error');
                    showResults();
                    return;
                }

                log('âœ… æˆåŠŸè·å–é±¼æ•°æ®ï¼', 'success');
                testResults.fishData = fishData;
                testResults.steps.push({ step: 3, status: 'success', data: fishData });

                // æ­¥éª¤ 4: éªŒè¯æ•°æ®å®Œæ•´æ€§
                log('<h3>âœ… æ­¥éª¤ 4: éªŒè¯æ•°æ®å®Œæ•´æ€§</h3>', 'info');
                
                const checks = {
                    hasId: !!fishData.id,
                    hasImageUrl: !!fishData.image_url,
                    imageUrlValid: fishData.image_url && fishData.image_url.startsWith('http'),
                    hasArtist: !!fishData.artist,
                    isApproved: fishData.is_approved === true
                };

                log(`é±¼ID: ${fishData.id ? 'âœ…' : 'âŒ'} ${fishData.id}`, checks.hasId ? 'success' : 'error');
                log(`é±¼åç§°: ${fishData.fish_name || 'æœªå‘½å'}`, 'info');
                log(`è‰ºæœ¯å®¶: ${fishData.artist ? 'âœ…' : 'âŒ'} ${fishData.artist || 'N/A'}`, checks.hasArtist ? 'success' : 'warning');
                log(`å›¾ç‰‡URL: ${fishData.image_url ? 'âœ…' : 'âŒ'} ${fishData.image_url || 'N/A'}`, checks.hasImageUrl ? 'success' : 'error');
                log(`URLæ ¼å¼: ${checks.imageUrlValid ? 'âœ… æœ‰æ•ˆ' : 'âŒ æ— æ•ˆ'}`, checks.imageUrlValid ? 'success' : 'error');
                log(`is_approved: ${fishData.is_approved === true ? 'âœ… true' : fishData.is_approved === false ? 'âŒ false' : 'âš ï¸ ' + fishData.is_approved}`, 
                    fishData.is_approved === true ? 'success' : 'warning');

                const allChecksPass = Object.values(checks).every(v => v);
                testResults.steps.push({ step: 4, status: allChecksPass ? 'success' : 'warning', checks });

                if (!allChecksPass) {
                    log('âš ï¸ éƒ¨åˆ†æ£€æŸ¥æœªé€šè¿‡ï¼Œå¯èƒ½å½±å“åŠ è½½', 'warning');
                    if (!checks.imageUrlValid) {
                        log('âŒ å…³é”®é—®é¢˜: å›¾ç‰‡URLæ— æ•ˆï¼Œé±¼å°†æ— æ³•æ˜¾ç¤ºï¼', 'error');
                        testResults.errors.push({ step: 'validation', error: 'Invalid image URL' });
                    }
                }

                // æ­¥éª¤ 5: æ¨¡æ‹ŸåŠ è½½åˆ°é±¼ç¼¸
                log('<h3>ğŸŠ æ­¥éª¤ 5: æ¨¡æ‹ŸåŠ è½½åˆ°é±¼ç¼¸</h3>', 'info');
                if (checks.imageUrlValid) {
                    log('âœ… å›¾ç‰‡URLæœ‰æ•ˆï¼Œå¯ä»¥è°ƒç”¨ loadFishImageToTank()', 'success');
                    log(`loadFishImageToTank("${fishData.image_url}", fishData)`, 'info');
                    log('âœ… é±¼åº”è¯¥èƒ½å¤ŸæˆåŠŸåŠ è½½å¹¶æ˜¾ç¤ºé‡‘è‰²å…‰ç¯ç‰¹æ•ˆ', 'success');
                    testResults.steps.push({ step: 5, status: 'success' });
                    
                    setStatus('âœ… æµ‹è¯•é€šè¿‡ï¼æ–°é±¼åº”è¯¥èƒ½æ­£å¸¸æ˜¾ç¤º', 'success');
                } else {
                    log('âŒ å›¾ç‰‡URLæ— æ•ˆï¼ŒloadFishImageToTank() å°†è·³è¿‡è¿™æ¡é±¼', 'error');
                    log('è¿™å°±æ˜¯ä¸ºä»€ä¹ˆæ–°é±¼æ²¡æœ‰å‡ºç°åœ¨é±¼ç¼¸ä¸­ï¼', 'error');
                    testResults.steps.push({ step: 5, status: 'error', reason: 'Invalid image URL' });
                    testResults.errors.push({ step: 'loadToTank', error: 'Cannot load fish with invalid image URL' });
                    
                    setStatus('âŒ æµ‹è¯•å¤±è´¥ï¼šå›¾ç‰‡URLæ— æ•ˆ', 'error');
                }

                // æ€»ç»“
                log('<h3>ğŸ“Š æµ‹è¯•æ€»ç»“</h3>', 'info');
                const totalSteps = testResults.steps.length;
                const successSteps = testResults.steps.filter(s => s.status === 'success').length;
                const errorCount = testResults.errors.length;

                log(`æ€»æ­¥éª¤: ${totalSteps}`, 'info');
                log(`æˆåŠŸ: ${successSteps}/${totalSteps}`, successSteps === totalSteps ? 'success' : 'warning');
                log(`é”™è¯¯: ${errorCount}`, errorCount === 0 ? 'success' : 'error');

                if (errorCount === 0 && checks.imageUrlValid) {
                    log('ğŸ‰ æ‰€æœ‰æ£€æŸ¥é€šè¿‡ï¼æ–°é±¼åº”è¯¥èƒ½å¤Ÿæ­£å¸¸åŠ è½½å’Œæ˜¾ç¤ºï¼', 'success');
                    log(`ğŸ’¡ å»ºè®®: è®¿é—® <a href="${tankUrl}" target="_blank">${tankUrl}</a> æŸ¥çœ‹æ•ˆæœ`, 'success');
                } else {
                    log('âš ï¸ å‘ç°é—®é¢˜ï¼Œè¯·æŸ¥çœ‹ä¸Šæ–¹çš„é”™è¯¯è¯¦æƒ…', 'warning');
                }

            } catch (error) {
                log(`âŒ æµ‹è¯•è¿‡ç¨‹ä¸­å‡ºé”™: ${error.message}`, 'error');
                log(`é”™è¯¯å †æ ˆ: ${error.stack}`, 'error');
                testResults.errors.push({ step: 'test', error: error.message, stack: error.stack });
                setStatus('âŒ æµ‹è¯•å¤±è´¥', 'error');
            }

            showResults();
        }

        // é¡µé¢åŠ è½½æ—¶çš„åˆå§‹åŒ–
        window.addEventListener('DOMContentLoaded', () => {
            log('âœ… æµ‹è¯•é¡µé¢åŠ è½½å®Œæˆ', 'success');
            log('ğŸ“Œ è¯·ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®å¼€å§‹æµ‹è¯•', 'info');
            log('ğŸ’¡ æç¤º: å…ˆåœ¨ä¸»é¡µç”»ä¸€æ¡é±¼å¹¶æäº¤ï¼Œç„¶åä½¿ç”¨è¿™ä¸ªé¡µé¢æµ‹è¯•', 'info');
        });
    </script>
</body>
</html>

























