# 实现计划

- [x] 1. 扩展 Supabase 认证模块



  - [x] 1.1 实现 signInAnonymously 函数

    - 在 `src/js/supabase-init.js` 中添加匿名登录函数
    - 调用 `supabase.auth.signInAnonymously()`
    - 处理错误情况并返回统一格式
    - _需求: 1.1, 1.2_
  - [x] 1.2 编写属性测试：匿名用户创建一致性


    - **属性 1: 匿名用户创建一致性**
    - **验证: 需求 1.1, 1.2**
  - [x] 1.3 实现 isAnonymousUser 函数


    - 检查 `user.is_anonymous` 属性
    - 兼容检查 `user.email` 和 `user.identities`
    - _需求: 3.1, 3.2_
  - [x] 1.4 编写属性测试：匿名用户识别准确性

    - **属性 4: 匿名用户识别准确性**
    - **验证: 需求 3.1, 3.2**
  - [x] 1.5 实现 getUserDisplayInfo 函数

    - 返回用户显示名称、是否匿名、是否显示升级提示
    - 匿名用户显示"访客"
    - _需求: 3.1, 3.2_

  - [x] 1.6 导出新函数到 window.supabaseAuth

    - 更新全局导出对象
    - _需求: 1.1_

- [x] 2. 检查点 - 确保所有测试通过


  - 确保所有测试通过，如有问题请询问用户。

- [x] 3. 实现账号升级功能

  - [x] 3.1 实现 upgradeWithEmail 函数


    - 调用 `supabase.auth.updateUser({ email, password })`
    - 处理邮箱已存在的错误
    - _需求: 2.1, 2.4_

  - [x] 3.2 实现 upgradeWithOAuth 函数
    - 调用 `supabase.auth.linkIdentity({ provider })`
    - 处理 OAuth 错误
    - _需求: 2.2_
  - [x] 3.3 编写属性测试：账号升级数据保留


    - **属性 3: 账号升级数据保留**
    - **验证: 需求 2.1, 2.2, 2.3, 6.4**

- [x] 4. 修改登录 UI 组件


  - [x] 4.1 在登录弹窗添加"跳过登录，先体验"按钮


    - 修改 `src/js/auth-ui.js` 的 `createLoginModal` 方法
    - 添加按钮样式和点击事件
    - _需求: 7.3, 7.4_
  - [x] 4.2 实现跳过登录的处理逻辑

    - 点击后调用 `signInAnonymously()`
    - 成功后关闭弹窗并更新 UI
    - _需求: 7.4_
  - [x] 4.3 更新用户状态显示逻辑

    - 匿名用户显示"访客"标识
    - 添加升级提示图标
    - _需求: 3.1_

- [x] 5. 添加主页入口



  - [x] 5.1 在 index.html 添加"立即体验"按钮

    - 在登录按钮旁边添加醒目的体验按钮
    - _需求: 7.1_

  - [x] 5.2 实现"立即体验"点击逻辑
    - 调用 `signInAnonymously()`
    - 成功后跳转到主功能页面
    - _需求: 7.2_

- [x] 6. 检查点 - 确保所有测试通过


  - 确保所有测试通过，如有问题请询问用户。



- [x] 7. 实现付费拦截逻辑
  - [x] 7.1 在会员购买页面添加匿名用户检查

    - 修改 `membership.html` 或相关 JS
    - 检测匿名用户并显示升级提示
    - _需求: 4.1_
  - [x] 7.2 实现升级弹窗组件

    - 创建账号升级弹窗 UI
    - 支持邮箱和 OAuth 两种升级方式
    - _需求: 2.1, 2.2_
  - [x] 7.3 编写属性测试：付费前账号检查

    - **属性 5: 付费前账号检查**
    - **验证: 需求 4.1**


- [x] 8. 实现会话恢复逻辑

  - [x] 8.1 更新 auth-ui.js 的初始化逻辑


    - 检查现有会话是否为匿名用户
    - 正确恢复匿名用户状态
    - _需求: 1.4_

  - [x] 8.2 编写属性测试：会话恢复身份一致性
    - **属性 2: 会话恢复身份一致性**
    - **验证: 需求 1.4**

- [x] 9. 添加个人资料页升级入口


  - [x] 9.1 在 profile.html 添加账号升级区域


    - 仅对匿名用户显示
    - 提供邮箱和社交账号升级选项
    - _需求: 3.3_

- [x] 10. 最终检查点 - 确保所有测试通过



  - 确保所有测试通过，如有问题请询问用户。

- [x] 11. 修复匿名登录后继续画鱼提交流程

  - [x] 11.1 修改 handleSkipLogin 方法
    - 在匿名登录成功后检查 `sessionStorage.getItem('pendingFishSubmit')`
    - 如果有待提交的鱼，触发 `swim-btn` 点击事件继续提交流程
    - _修复: 用户画鱼后点击提交，选择"Skip & Try First"匿名登录后，应继续显示"Name Your Fish!"弹窗_

  - [x] 11.2 修改 handleTryNow 方法
    - 同样添加待提交鱼的检查逻辑
    - 保持与 handleSkipLogin 一致的行为
